# AVATAR OnE 플랫폼 기능명세서 변경사항

**v1.2 → v1.3**
**작성일:** 2026-02-09
**변경 범위:** Builder 리팩토링, 승인 로직 변경, 데이터 모델 변경

---

## 변경 개요

v1.3에서는 Builder의 파이프라인 정의 방식을 근본적으로 변경한다. 기존에는 파이프라인 단위로 하나의 컨테이너 이미지와 자원을 할당했으나, v1.3부터 각 컴포넌트가 독립된 컨테이너로 실행되는 구조를 반영하여 **컴포넌트별 이미지 및 자원 할당**을 지원한다. Builder 화면은 **컴포넌트 관리**와 **워크플로우 구성** 두 개의 탭으로 분리된다.

---

## 1. 전체 워크플로우 (섹션 1) — 변경

### 변경 전 (v1.2)
```
Builder로 파이프라인 정의 → 워크로드 실행 요청 → 테스트 실행 및 승인 → 대기열 → 실행 → 결과
```

### 변경 후 (v1.3)
```
Builder 컴포넌트 정의 → 워크플로우 구성 → 워크로드 실행 요청 → 테스트 실행 및 승인 → 대기열 → 실행 → 결과
```

- 단계 1의 설명 변경:
  - **Before:** "사용자가 컨테이너 이미지, 환경 변수, 컴포넌트 스펙을 입력하면 스펙 파일(JSON)이 생성된다."
  - **After:** "사용자가 독립 컨테이너로 실행되는 컴포넌트를 정의하고(각 컴포넌트별 이미지, 자원 할당), 컴포넌트 간 실행 의존 관계를 워크플로우로 구성하면 스펙 파일(JSON)이 생성된다."

---

## 2. Builder — 파이프라인 정의 (섹션 2) — 대폭 변경

### 2.1 기능 명세 — 변경/추가 항목

| ID | 기능명 | v1.2 설명 | v1.3 변경사항 | 비고 |
|----|--------|-----------|---------------|------|
| BL-01 | 컨테이너 이미지 입력 | 파이프라인에 하나의 이미지 입력 | **컴포넌트별로 각각의 컨테이너 이미지를 입력한다** (레지스트리 주소, 태그). 각 컴포넌트는 독립 컨테이너로 실행됨 | **변경** |
| BL-02 | 환경 변수 설정 | (변경 없음) | 환경 변수는 파이프라인 레벨로 유지. 모든 컴포넌트가 공유 | 유지 |
| BL-03 | 컴포넌트 스펙 정의 | 컴포넌트 유형, 파라미터, 실행 순서 | **컴포넌트별 Docker 이미지, GPU 유형/수, 메모리, 유형, 파라미터, 실행 순서를 정의한다.** 각 컴포넌트가 독립된 자원 할당을 가짐 | **변경** |
| BL-04 | 스펙 파일 생성 | (변경 없음 - 구조만 변경) | 생성되는 스펙 파일의 JSON 구조가 변경됨 (아래 2.2 참조) | 유지 |
| BL-05 | 스펙 파일 조회 | (변경 없음) | 목록에 컴포넌트 수, 최대 자원 요약 표시 | 유지 |
| **BL-06** | **Builder 탭 분리** | *(신규)* | **Builder 화면을 "컴포넌트 관리" 탭과 "워크플로우 구성" 탭으로 분리한다** | **추가** |
| **BL-07** | **컴포넌트 CRUD** | *(신규)* | **컴포넌트 관리 탭에서 컴포넌트를 추가, 편집, 삭제할 수 있다. 삭제 시 관련 워크플로우 연결이 자동 제거된다** | **추가** |
| **BL-08** | **컴포넌트별 자원 할당** | *(신규)* | **각 컴포넌트에 GPU 유형, GPU 수, 메모리를 독립적으로 할당한다. 컴포넌트별 임계치 초과 여부를 실시간 표시한다** | **추가** |
| **BL-09** | **워크플로우 구성** | *(신규)* | **워크플로우 구성 탭에서 컴포넌트 간 실행 의존 관계(엣지)를 정의한다. 실행 순서를 조정할 수 있다** | **추가** |
| **BL-10** | **워크플로우 시각화** | *(신규)* | **정의된 워크플로우를 SVG 다이어그램으로 실시간 미리보기한다. 컴포넌트 유형별 색상 구분, 방향 화살표 표시** | **추가** |
| **BL-11** | **워크플로우 유효성 검증** | *(신규)* | **순환 참조(cycle) 감지, 자기 참조(self-loop) 방지, 중복 연결 방지. 유효성 위반 시 한국어 오류 메시지 표시** | **추가** |

### 2.2 스펙 파일 구조 — 변경

#### 변경 전 (v1.2)

| 필드 | 설명 |
|------|------|
| pipeline_id | 파이프라인 고유 식별자 |
| version | 스펙 파일 버전 |
| **image** | **컨테이너 이미지 정보 (registry, name, tag) — 파이프라인에 1개** |
| env_vars | 환경 변수 목록 (Key-Value) |
| components[] | 컴포넌트 목록: 각 컴포넌트의 유형, 파라미터, 실행 순서, 의존성 |
| **resources** | **필요 자원량 (GPU 수/유형, 메모리, CPU) — 파이프라인 레벨** |
| test_run_ref | 테스트 실행 결과 참조 (run ID, 선택 사항) |

#### 변경 후 (v1.3)

| 필드 | 설명 | 변경 |
|------|------|------|
| pipeline_id | 파이프라인 고유 식별자 | 유지 |
| version | 스펙 파일 버전 | 유지 |
| ~~image~~ | ~~삭제됨~~ | **삭제** — 컴포넌트별로 이동 |
| env_vars | 환경 변수 목록 (Key-Value) — 파이프라인 레벨, 모든 컴포넌트 공유 | 유지 |
| **components[]** | 컴포넌트 목록: 각 컴포넌트의 **이미지, 자원, 유형, 파라미터, 실행 순서** | **변경** |
| ~~resources~~ | ~~삭제됨~~ | **삭제** — 컴포넌트별로 이동 |
| **workflow[]** | **컴포넌트 간 의존 관계 (from → to 엣지 목록)** | **추가** |
| storage | 저장소 설정 | 유지 |
| created_at | 생성 일시 | 유지 |
| test_run_ref | 테스트 실행 결과 참조 (run ID, 선택 사항) | 유지 |

#### components[] 내부 구조 변경

| 필드 | v1.2 | v1.3 | 비고 |
|------|------|------|------|
| order | O | O | 유지 |
| name | O | O | 유지 |
| type | O | O | 유지 (trainer, data_loader, preprocessor, evaluator) |
| params | O | O | 유지 |
| **image** | X | **O** | **추가** — 컴포넌트별 Docker 이미지 (registry + tag) |
| **resources** | X | **O** | **추가** — 컴포넌트별 자원 (gpu_type, gpu_count, memory) |

#### 스펙 파일 JSON 예시 (v1.3)

```json
{
  "pipeline_id": "PL-A1B2C3",
  "name": "LLM-FineTune-v3",
  "version": "1.0.0",
  "env_vars": {
    "NCCL_DEBUG": "INFO",
    "CUDA_VISIBLE_DEVICES": "all"
  },
  "components": [
    {
      "order": 1,
      "name": "data-loader",
      "type": "data_loader",
      "image": { "registry": "registry.avatar.io/data-loader", "tag": "1.0" },
      "resources": { "gpu_type": "V100", "gpu_count": 1, "memory": "32GB" },
      "params": {}
    },
    {
      "order": 2,
      "name": "preprocessor",
      "type": "preprocessor",
      "image": { "registry": "registry.avatar.io/preprocessor", "tag": "2.1" },
      "resources": { "gpu_type": "A100", "gpu_count": 2, "memory": "64GB" },
      "params": { "batch_size": 128 }
    },
    {
      "order": 3,
      "name": "trainer",
      "type": "trainer",
      "image": { "registry": "registry.avatar.io/llm-trainer", "tag": "3.1" },
      "resources": { "gpu_type": "A100", "gpu_count": 4, "memory": "128GB" },
      "params": { "lr": 0.001, "epochs": 30 }
    },
    {
      "order": 4,
      "name": "evaluator",
      "type": "evaluator",
      "image": { "registry": "registry.avatar.io/evaluator", "tag": "1.5" },
      "resources": { "gpu_type": "V100", "gpu_count": 1, "memory": "16GB" },
      "params": {}
    }
  ],
  "workflow": [
    { "from": "C-001", "to": "C-002" },
    { "from": "C-002", "to": "C-003" },
    { "from": "C-003", "to": "C-004" }
  ],
  "storage": {
    "type": "distributed",
    "path": "/training-data/llm-finetune-v3"
  },
  "created_at": "2026-02-09T09:00:00.000Z"
}
```

### 2.3 Builder 화면 구성 — 변경

#### 변경 전 (v1.2)
단일 폼: 파이프라인 기본 정보 → 환경 변수 → 컴포넌트 스펙 → 스펙 파일 생성

#### 변경 후 (v1.3)

**탭 1: 컴포넌트 관리**

| 영역 | 내용 |
|------|------|
| 기본 정보 카드 | 파이프라인 이름, 버전 |
| 환경 변수 카드 | Key-Value 목록 (추가/삭제) — 파이프라인 레벨 |
| 컴포넌트 목록 | 컴포넌트별 독립 카드: 이름, 유형(드롭다운), Docker 이미지, 태그, GPU 유형, GPU 수, 메모리, 파라미터(JSON) |
| 컴포넌트별 임계치 표시 | 각 컴포넌트의 자원이 임계치를 초과하면 경고 배지 표시 |
| 액션 | [컴포넌트 추가], [컴포넌트 삭제], [스펙 파일 생성] |

**탭 2: 워크플로우 구성**

| 영역 | 내용 |
|------|------|
| 실행 순서 테이블 | 컴포넌트를 순서대로 표시. 위/아래 버튼으로 순서 조정 |
| 의존 관계 편집기 | 드롭다운(From → To)으로 엣지 추가. 기존 엣지 목록에서 삭제 가능 |
| 유효성 검증 | 순환 참조, 자기 참조, 중복 연결 자동 방지 (한국어 오류 메시지) |
| 워크플로우 다이어그램 | SVG 기반 실시간 미리보기. 컴포넌트를 유형별 색상 노드로, 의존 관계를 방향 화살표로 표시 |

**워크플로우 다이어그램 사양:**
- 노드: 컴포넌트명 + 유형 라벨 + 자원 요약 표시
- 색상: trainer(파랑), data_loader(초록), preprocessor(노랑), evaluator(보라)
- 엣지: 방향 화살표 (SVG, 외부 라이브러리 미사용)
- 레이아웃: 왼쪽→오른쪽 위상 정렬(topological sort) 기반 자동 배치

---

## 3. 워크로드 실행 요청 및 승인 (섹션 3) — 부분 변경

### 3.1 실행 요청 — 변경 항목

| ID | 기능명 | v1.3 변경사항 |
|----|--------|---------------|
| WR-02 | 자원 요청량 설정 | 선택한 스펙 파일의 **컴포넌트별 최대 자원값으로 자동 입력**됨. 사용자가 수정 가능 |

### 3.2 승인 프로세스 — 변경 항목

| ID | 기능명 | v1.2 설명 | v1.3 변경사항 |
|----|--------|-----------|---------------|
| AP-05 | 승인/반려 처리 | 자원 요청량이 임계치 이상이면 관리자 승인 | **승인 기준 변경**: 개별 컴포넌트 중 가장 큰 자원 요청이 임계치 이상이면 관리자 승인 필요. 임계치 미만이면 자동 실행 |

### 3.3 자원 임계치 승인 기준 — 변경

| 항목 | v1.2 | v1.3 |
|------|------|------|
| 판단 기준 | 파이프라인 전체의 GPU 수, 메모리 | **컴포넌트별 최대값** (가장 큰 단일 컴포넌트의 자원) |
| 임계치 | GPU ≥ 4기 또는 메모리 ≥ 128GB | GPU ≥ 4기 또는 메모리 ≥ 128GB (동일) |
| 초과 판단 | 파이프라인의 gpu/mem이 임계치 이상 | **어느 하나의 컴포넌트라도** GPU ≥ 4 또는 메모리 ≥ 128GB이면 초과 |

**예시:**
파이프라인에 3개 컴포넌트가 있을 때:
| 컴포넌트 | GPU | 메모리 |
|----------|-----|--------|
| data-loader | V100 x 1 | 32GB |
| preprocessor | A100 x 2 | 64GB |
| trainer | A100 x 4 | 128GB |

→ trainer 컴포넌트가 GPU 4기(≥ 4), 메모리 128GB(≥ 128GB)이므로 **관리자 승인 필요**

---

## 4~6. 실행 대기열, 리소스 관리, 결과 모델 (섹션 4~6) — 변경 없음

이 섹션들은 워크로드 데이터(workload)를 소비하며, 스펙 데이터를 직접 참조하지 않으므로 변경 없음.

---

## 7. 워크플로우 엣지 유효성 검증 — 추가

| 검증 항목 | 오류 메시지 | 설명 |
|-----------|-------------|------|
| 자기 참조 | "자기 자신으로의 연결은 허용되지 않습니다" | 컴포넌트가 자기 자신으로 연결하는 것을 방지 |
| 중복 연결 | "이미 존재하는 연결입니다" | 동일한 From→To 엣지의 중복 추가를 방지 |
| 순환 참조 | "순환 참조가 감지되었습니다. 이 연결을 추가하면 순환이 발생합니다" | A→B→C→A 같은 순환 의존 관계를 DFS 기반으로 감지하여 방지 |

---

## 8. 컴포넌트 삭제 시 동작 — 추가

컴포넌트 삭제 시 다음 작업이 자동으로 수행된다:

1. 컴포넌트 목록에서 해당 컴포넌트 제거
2. 해당 컴포넌트를 참조하는 모든 워크플로우 엣지 자동 제거
3. 나머지 컴포넌트의 실행 순서(order) 재계산

---

## 9. 테스트 실행 기록 — 보존 정책

테스트 실행 기록은 **실행 시점의 자원 정보를 스냅샷으로 보관**한다. 스펙의 데이터 모델이 변경되더라도 기존 테스트 실행 기록의 구조는 변경되지 않는다. 새로운 테스트 실행 시에는 스펙의 컴포넌트 중 최대 자원값을 추출하여 기록한다.

---

## 10. 구현 로드맵 (섹션 11) — 변경

### Phase 1 추가 항목 (v1.3)

기존 Phase 1 항목에 다음을 추가:

- **Builder 컴포넌트 관리:** 컴포넌트별 Docker 이미지, 자원 할당 CRUD
- **Builder 워크플로우 구성:** 컴포넌트 간 의존 관계 정의, 순서 편집
- **워크플로우 시각화:** SVG 기반 다이어그램 미리보기
- **워크플로우 유효성 검증:** 순환 참조 감지, 자기 참조/중복 방지
- **승인 로직 변경:** 컴포넌트별 최대값 기준 임계치 판단

### Phase 2 조정

기존 Phase 2 항목 중 "그래프 기반 시각적 편집기"는 v1.3의 워크플로우 구성 탭으로 부분 구현됨. Phase 2에서는 다음으로 고도화:

- ~~그래프 기반 시각적 편집기~~ → 드래그 앤 드롭 기반 시각적 편집기 (v1.3 SVG 미리보기의 고도화)
- 컴포넌트 템플릿 라이브러리
- 스펙 파일 버전 관리

---

## 변경 영향도 요약

| 영역 | 영향도 | 설명 |
|------|--------|------|
| Builder | **높음** | 전면 재구성 (탭 분리, 컴포넌트별 이미지/자원) |
| 스펙 파일 구조 | **높음** | JSON 구조 변경 (image/resources가 components 내부로 이동, workflow 추가) |
| 승인 로직 | **중간** | 임계치 판단 기준 변경 (파이프라인 → 컴포넌트별 최대값) |
| 실행 요청 | **낮음** | 자원 자동 입력 추가, 기존 흐름 유지 |
| 테스트 실행 | **낮음** | 기록 표시 방식만 변경, 기존 기록 보존 |
| 대기열/리소스/모델 | **없음** | 변경 없음 |

---

## 버전 정보

| 항목 | v1.2 | v1.3 |
|------|------|------|
| 플랫폼 버전 표시 | v1.2 | v1.3 |
| 스펙 파일 구조 버전 | 단일 이미지/자원 | 컴포넌트별 이미지/자원 + 워크플로우 |
| 워크플로우 변경 | 5단계 | 6단계 (Builder 분리) |
